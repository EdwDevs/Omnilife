<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#2563eb" />
  <title>CRM Pedidos Farmac茅utico Pro</title>

  <!-- Bootstrap (base, puede ser sustituido/override por styles.css) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome para iconograf铆a -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <!-- Fuente moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tu CSS modernizado (adjuntar despu茅s) -->
  <link rel="stylesheet" href="./styles.css">

  <style>
    /* Peque帽os ajustes inline para evitar flash de layout antes de cargar styles.css */
    html { font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    body { margin: 0; background: #f8fafc; color: #1f2937; -webkit-font-smoothing:antialiased; }
    /* Mantener el 谩rea visible arriba para mobiles con notch */
    :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
    header { padding-top: calc(0.5rem + var(--safe-top)); }
  </style>
</head>
<body>
  <!-- Accesibilidad: aviso si JS est谩 desactivado -->
  <noscript>
    <div class="alert alert-warning text-center m-0">
      Esta app requiere JavaScript. Activa JavaScript para usar la interfaz completa.
    </div>
  </noscript>

  <!-- HEADER -->
  <header class="main-header sticky-top" role="banner" aria-label="Encabezado principal">
    <div class="container-fluid d-flex flex-column align-items-center justify-content-center">
      <div class="d-flex align-items-center gap-3 w-100 justify-content-center">
        <i class="fa-solid fa-prescription-bottle text-white" style="font-size:1.6rem" aria-hidden="true"></i>
        <h1 class="h5 text-white mb-0" style="font-weight:700;">CRM Pedidos Farmac茅utico Pro</h1>
      </div>
      <small class="text-white-50">Sistema de Gesti贸n de Pedidos Profesional</small>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container-fluid mt-3 mb-5" role="main">
    <!-- Estad铆sticas (oculto cuando no hay datos) -->
    <section id="statsContainer" class="stats-container mb-3 visually-hidden" aria-live="polite" aria-atomic="true">
      <div class="stat-card" role="status" aria-label="Total Pedidos">
        <span id="totalOrders" class="stat-value">0</span>
        <span class="stat-label"><i class="fa-solid fa-file-invoice me-1" aria-hidden="true"></i> Total Pedidos</span>
      </div>
      <div class="stat-card" role="status" aria-label="Valor Total">
        <span id="totalValue" class="stat-value">$0</span>
        <span class="stat-label"><i class="fa-solid fa-dollar-sign me-1" aria-hidden="true"></i> Valor Total</span>
      </div>
      <div class="stat-card" role="status" aria-label="Clientes">
        <span id="totalClients" class="stat-value">0</span>
        <span class="stat-label"><i class="fa-solid fa-users me-1" aria-hidden="true"></i> Clientes</span>
      </div>
      <div class="stat-card" role="status" aria-label="Promedio">
        <span id="avgOrderValue" class="stat-value">$0</span>
        <span class="stat-label"><i class="fa-solid fa-chart-line me-1" aria-hidden="true"></i> Promedio</span>
      </div>
    </section>

    <!-- Tabs: Crear pedido / Historial -->
    <section class="tab-content" id="myTabContent" aria-live="polite">
      <!-- Crear pedido -->
      <article class="tab-pane fade show active" id="create-order-tab" role="tabpanel" aria-labelledby="nav-create-order-tab">
        <!-- Card: Datos cliente / dep贸sito -->
        <div class="card mb-3">
          <div class="card-body">
            <div id="editing-banner" class="alert alert-warning d-none" role="status" aria-live="polite">
              <i class="fa-solid fa-pencil me-2" aria-hidden="true"></i>
              <strong>Modo Edici贸n:</strong> Est谩s modificando un pedido existente.
            </div>

            <div class="row g-2">
              <div class="col-12 col-md-6">
                <label for="clientNameInput" class="form-label"> 
                  <i class="fa-solid fa-building me-2 text-primary" aria-hidden="true"></i>
                  Nombre del Cliente
                </label>
                <input id="clientNameInput" class="form-control" type="text" inputmode="text" autocomplete="organization" placeholder="Ej: Droguer铆a La Principal" aria-required="true">
              </div>

              <div class="col-12 col-md-6">
                <label for="supplierSelect" class="form-label">
                  <i class="fa-solid fa-warehouse me-2 text-primary" aria-hidden="true"></i>
                  Dep贸sito
                </label>
                <select id="supplierSelect" class="form-select" aria-required="true">
                  <option value="" selected disabled>-- Seleccione un dep贸sito --</option>
                  <option value="DROSAN"> DROSAN</option>
                  <option value="UNIDROGAS"> UNIDROGAS</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Filtros r谩pidos -->
        <div class="filters-container card mb-3">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0"><i class="fa-solid fa-filter me-2 text-primary" aria-hidden="true"></i> Filtros R谩pidos</h6>
              <small class="text-muted">Toque para filtrar</small>
            </div>
            <div id="filterChips" class="mt-2" role="toolbar" aria-label="Filtros de producto">
              <button class="filter-chip active btn" data-filter="all" type="button" aria-pressed="true"> <i class="fa-solid fa-list me-1"></i> Todos</button>
              <button class="filter-chip btn" data-filter="respiratory" type="button"> <i class="fa-solid fa-lungs me-1"></i> Respiratorio</button>
              <button class="filter-chip btn" data-filter="topical" type="button"> <i class="fa-solid fa-hand-holding-medical me-1"></i> T贸picos</button>
              <button class="filter-chip btn" data-filter="gastrointestinal" type="button"> <i class="fa-solid fa-stomach me-1"></i> Digestivo</button>
              <button class="filter-chip btn" data-filter="gynecological" type="button"> <i class="fa-solid fa-venus me-1"></i> Ginecol贸gico</button>
            </div>
          </div>
        </div>

        <!-- Buscador + Lista de productos -->
        <div class="card">
          <div class="card-header">
            <div class="search-container">
              <div class="input-group">
                <span class="input-group-text" id="search-addon"><i class="fa-solid fa-search" aria-hidden="true"></i></span>
                <input id="productSearch" class="form-control" type="search" autocomplete="off" placeholder="Buscar por nombre, referencia o principio activo..." aria-label="Buscar productos" aria-describedby="search-addon">
              </div>
            </div>
          </div>

          <div class="card-body p-0">
            <div id="productList" class="list-group list-group-flush product-list-container" role="list" aria-label="Lista de productos">
              <!-- El contenido se renderiza din谩micamente -->
              <div class="text-center p-4">
                <div class="loading" aria-hidden="true"></div>
                <p class="mt-2 text-muted">Cargando productos...</p>
              </div>
            </div>
          </div>
        </div>
      </article>

      <!-- Historial -->
      <article class="tab-pane fade" id="history-tab" role="tabpanel" aria-labelledby="nav-history-tab">
        <div class="d-flex justify-content-between align-items-center mb-3 gap-2">
          <h6 class="mb-0"><i class="fa-solid fa-history me-2 text-primary" aria-hidden="true"></i> Historial de Pedidos</h6>
          <button id="exportBtn" class="export-btn btn" type="button" aria-label="Exportar historial a Excel">
            <i class="fa-solid fa-download me-2" aria-hidden="true"></i> Exportar Excel
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-file-invoice me-2" aria-hidden="true"></i> Pedidos por Cliente
          </div>
          <div class="card-body">
            <div class="accordion" id="orderHistoryContainer" role="region" aria-live="polite">
              <div class="text-center p-4">
                <div class="loading" aria-hidden="true"></div>
                <p class="mt-2 text-muted">Cargando historial...</p>
              </div>
            </div>
          </div>
        </div>
      </article>
    </section>
  </main>

  <!-- BOTTOM NAV (optimizado t谩ctil) -->
  <nav class="bottom-nav" role="navigation" aria-label="Navegaci贸n inferior">
    <div class="nav nav-pills nav-fill" id="nav-tab" role="tablist">
      <button class="nav-link active" id="nav-create-order-tab" data-bs-toggle="tab" data-bs-target="#create-order-tab" type="button" role="tab" aria-controls="create-order-tab" aria-selected="true">
        <i class="fa-solid fa-plus-circle" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">Crear Pedido</span>
      </button>
      <button class="nav-link" id="nav-history-tab" data-bs-toggle="tab" data-bs-target="#history-tab" type="button" role="tab" aria-controls="history-tab" aria-selected="false">
        <i class="fa-solid fa-list-alt" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">Historial</span>
      </button>
    </div>
  </nav>

  <!-- FAB carrito -->
  <button class="fab-cart" id="openCartBtn" aria-label="Abrir resumen del pedido" data-bs-toggle="modal" data-bs-target="#cartModal">
    <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
    <span id="cart-item-count" class="badge bg-danger rounded-pill">0</span>
  </button>

  <!-- Modal: Resumen del carrito -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content" role="dialog" aria-modal="true">
        <div class="modal-header" style="background: var(--bg-gradient); color: white;">
          <h5 id="cartModalLabel" class="modal-title">
            <i class="fa-solid fa-shopping-cart me-2" aria-hidden="true"></i> Resumen del Pedido
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div id="currentOrderInfo" class="alert alert-info small border-0 visually-hidden" aria-live="polite"></div>
          <div id="currentOrderItems" aria-live="polite"></div>
          <hr>
          <div id="cart-total" class="fs-5 fw-bold text-end text-primary" aria-atomic="true"></div>
        </div>

        <div class="modal-footer justify-content-between">
          <div class="d-flex gap-2">
            <button id="clearOrderBtn" class="btn btn-outline-danger" type="button"><i class="fa-solid fa-trash me-1"></i> Limpiar</button>
            <button id="cancelEditBtn" class="btn btn-outline-secondary d-none" type="button"><i class="fa-solid fa-times me-1"></i> Cancelar Edici贸n</button>
          </div>
          <button id="finalizeOrderBtn" class="btn btn-primary" type="button" disabled><i class="fa-solid fa-check-circle me-1"></i> Finalizar Pedido</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" aria-live="polite" aria-atomic="true">
    <div id="liveToast" class="toast" role="alert">
      <div class="toast-header">
        <i id="toastIcon" class="fa-solid fa-check-circle text-success me-2" aria-hidden="true"></i>
        <strong class="me-auto">Notificaci贸n</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
      <div id="toast-body-content" class="toast-body"></div>
    </div>
  </div>

  <!-- Dependencias: Bootstrap JS + XLSX (puede quedarse en el HTML o dentro de script.js si prefieres) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

  <!-- Tu JS modular modernizado (adjuntar despu茅s) -->
  <script type="module" src="./script.js"></script>
</body>
</html>
